services:
  delilah_brain_v2:
    container_name: delilah_brain_v2
  networks:
    - delilah_net

    build:
      context: .
      dockerfile: Dockerfile.delilah_brain_v2
      args:
        INSTALL_DEV_TOOLS: "1"
    # NOTE: Uvicorn listens on 8800 inside container
    # Host exposes it on 8801
    ports:
      - "8801:8800"
    volumes:
      - /home/dad/delilah_workspace:/app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PYTHONUNBUFFERED: "1"

      # Timeouts / guards
      TOOL_TIMEOUT_S: "8"
      OLLAMA_TIMEOUT_S: "20"
      QDRANT_TIMEOUT_S: "2"

      # Dependencies
      OLLAMA_URL: "http://ollama:11434"
      QDRANT_URL: "http://qdrant:6333"
      DATABASE_URL: "postgresql://delilah:delilah_change_me@delilah_postgres:5432/delilah"


      # Postgres system-of-record (write-only logging for now)
      DATABASE_URL: "postgresql://delilah:delilah_change_me@host.docker.internal:5432/delilah"
      PG_LOGGING_ENABLED: "1"

      # Models
      CHAT_MODEL: "llama3:8b"
      EMBED_MODEL: "nomic-embed-text"
      EMBED_DIM: "768"

      # v768 collections
      COL_KNOWLEDGE: "delilah_knowledge_v768"
      COL_ROUTER_HINTS: "router_hints_v768"
      COL_PERSONA: "persona_memory_v768"
      COL_CONVO: "conversation_memory_v768"
  networks:
    delilah_net:
      external: true

    restart: unless-stopped
