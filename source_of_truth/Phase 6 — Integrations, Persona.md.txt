# Phase 6 â€” Integrations, Persona, and Orchestration

**Status:** NOT STARTED  
**Baseline Tag:** delilah-brain-v2-baseline-2025-12-26  
**Last Verified:** __________________  
**Owner:** __________________

---

## Phase 6 Objectives

Phase 6 expands Delilah Brain v2 with:
- Safe external API integrations
- Persona as state (not prompt soup)
- Mixture-of-Experts routing
- Asynchronous cloud fallback (â€œjury of oraclesâ€)

WITHOUT regressing:
- baseline stability
- data persistence rules
- tool isolation guarantees

---

## Global Non-Negotiables (Must Hold at All Times)

- Brain API stable on port `:8800`
- Exactly **one** active brain service
- Volatile tools (weather, sports, prices):
  - âŒ no Postgres writes
  - âŒ no Qdrant writes
  - âŒ no RAG context
- All changes are reversible via:
  - Git tag
  - ZFS snapshot
  - backup archive

---

## Phase 6.0 â€” Guardrails & Regression Harness

### 6.0.1 Regression Harness
**Deliverable:** `make verify`

**Definition of Done:**
- Compose renders
- Brain container healthy
- Dependencies reachable
- Postgres reachable
- No restart loops

**Verification:**
```bash
make verify

STOP if verify fails.

6.0.2 Central Policy Enforcement

Deliverable: single policy module controlling:

persistence eligibility

RAG eligibility

volatility classification

Verification:

Weather request â†’ tool only, no RAG

Postgres shows zero weather rows

Phase 6.1 â€” Tool Framework Expansion
6.1.1 Tool Registry

Deliverable: unified tool registry with standard return contract

Verification:

make smoke-tools

6.1.2 Sports Scores Tool

Classification: volatile

Verification:

/ask routes to sports tool

used_context=false

Postgres shows zero sports rows

6.1.3 Google API Tools (v1)

Start with: read-only Google Calendar

Verification:

OAuth works

Read-only calls succeed

No implicit persistence

Phase 6.2 â€” Persona v1 (Stateful)
6.2.1 Persona State Object

Deliverable: persona_profile, context_mode, user_mood

Verification:

Verbosity/tone change works

Persona does not leak into Qdrant

6.2.2 Persona Overrides

Deliverable: per-request overrides

Verification:

Overrides apply once

Reset correctly

Phase 6.3 â€” Mixture of Experts (MoE) v1
6.3.1 Router Plan Output

Deliverable: structured routing plan

Verification:

Tool intents bypass RAG

Knowledge intents select collections

6.3.2 Expert Nodes

Deliverable: General + Coding experts

Verification:

Correct expert selected

Latency unchanged or improved

Phase 6.4 â€” Cloud Fallback & Jury of Oracles
6.4.1 Fallback Triggers

Deliverable: explicit fallback criteria

Verification:

Triggered only when appropriate

6.4.2 Jury Workflow (Async)

Deliverable: n8n or internal async workflow

Verification:

Multi-source responses

Curated summary with citations

Volatile content rejected

6.4.3 Curated Ingestion

Deliverable: stable-only RAG ingestion

Verification:

Stable facts embedded

Volatile facts excluded

Phase 6.5 â€” Serving Upgrade Readiness (No vLLM Yet)
6.5.1 LLM Provider Abstraction

Deliverable: Ollama â†” vLLM switchable via config

Verification:

All previous tests still pass

Phase 6 Completion Criteria

Phase 6 is COMPLETE when:

make verify passes

make smoke passes

No volatile data persisted

Persona + tools + MoE coexist without regression

Change Log
Date	Change	Verified By
		

---

# ðŸ›  `Makefile` â€” Verify & Smoke Structure

Place this in `/srv/delilah/Makefile` (or merge into existing).

```makefile
.PHONY: verify smoke smoke-tools smoke-weather smoke-postgres

# -----------------------
# Core verification
# -----------------------

verify:
	@echo "== Compose render =="
	docker compose config > /tmp/delilah.rendered.yml

	@echo "== Brain container status =="
	docker compose ps delilah_brain_v2

	@echo "== Health check =="
	curl -fsS http://127.0.0.1:8800/health

	@echo "== DNS inside container =="
	docker compose exec -T delilah_brain_v2 bash -lc 'getent hosts ollama qdrant'

	@echo "== Postgres connectivity =="
	docker compose exec -T delilah_brain_v2 bash -lc 'python - <<PY
import os, psycopg
with psycopg.connect(os.environ["DATABASE_URL"]) as conn:
  with conn.cursor() as cur:
    cur.execute("select 1")
    print(cur.fetchone())
PY'

	@echo "VERIFY OK"

# -----------------------
# Smoke tests
# -----------------------

smoke: smoke-weather smoke-tools smoke-postgres
	@echo "SMOKE OK"

smoke-weather:
	@echo "== Weather tool smoke test =="
	curl -fsS -X POST http://127.0.0.1:8800/ask \
	  -H "Content-Type: application/json" \
	  -d '{"user_id":"smoke","text":"Weather in Rockford, MI?"}' \
	  | jq .

smoke-tools:
	@echo "== Tool registry check =="
	docker compose exec -T delilah_brain_v2 bash -lc 'python - <<PY
from orchestrator import TOOL_REGISTRY
print(sorted(TOOL_REGISTRY.keys()))
PY'

smoke-postgres:
	@echo "== Verify no weather persisted =="
	cd /home/dad/delilah_workspace && \
	docker compose -f docker-compose.delilah_infra.yml exec -T delilah_postgres \
	psql -U delilah -d delilah -c \
	"SELECT count(*) FROM brain.tool_calls WHERE tool = 'weather';"

How you will use this (important)

Your Phase 6 discipline becomes:

Before any change

make verify


After each deliverable

make smoke


If either fails

STOP

fix immediately

do not continue Phase 6 work

This structure is what prevents:

silent regressions

RAG bleed into tools

accidental persistence

â€œit worked yesterdayâ€ failures